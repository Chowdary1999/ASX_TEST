<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASX Swing Trader — Advisor + Tracking + AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #0b1020; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: #e2e8f0; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(148,163,184,0.15); border-radius: 1rem; }
    .glass { background: rgba(255,255,255,0.06); border: 1px solid rgba(148,163,184,0.18); border-radius: .75rem; }
    .btn { transition: transform .06s ease; } .btn:active{ transform: translateY(1px); }
    .muted{ color:#94a3b8; }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API = '/.netlify/functions/market';

    const MAX_INVEST = 1000;

    function useLocal(key, init){
      const [v,setV] = React.useState(()=>{
        try{ const s = localStorage.getItem(key); return s?JSON.parse(s):init; }catch{return init;}
      });
      useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(v)); }catch{} }, [v]);
      return [v,setV];
    }

    function Header(){ return (
      <header className="p-6">
        <h1 className="text-2xl md:text-3xl font-semibold">ASX Swing Trader <span className="text-violet-400">· advisor + AI</span></h1>
        <p className="text-slate-400 text-sm mt-1">Max invest A${MAX_INVEST} · AI advice via OpenAI API</p>
      </header>
    );}

    function DailyPick({ onPurchase }){
      const [pick,setPick]=useState(null);
      const [err,setErr]=useState(null);
      const [loading,setLoading]=useState(false);

      async function refresh(){
        setErr(null); setLoading(true);
        try{
          const res = await fetch(`${API}?fn=pick`);
          const data = await res.json();
          if(data.error) throw new Error(data.error);
          setPick(data);
        }catch(e){ setErr(e.message); setPick(null); }
        finally{ setLoading(false); }
      }

      useEffect(()=>{ refresh(); }, []);

      const qty = pick ? Math.floor(MAX_INVEST / Number(pick.last)) : 0;

      async function askAI(){
        const r = await fetch('/.netlify/functions/advice?mode=pick');
        const j = await r.json();
        alert('AI pick advice:\\n' + JSON.stringify(j.advice, null, 2));
      }

      return (
        <div className="card p-5 md:p-6 space-y-3">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold">Daily Pick (AI-ranked)</h2>
            <button className="btn px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={refresh} disabled={loading}>{loading?'Loading…':'Refresh'}</button>
          </div>
          {err && <p className="text-sm text-rose-400">⚠️ {err}</p>}
          {pick && (
            <div>
              <p>{pick.symbol} @ {Number(pick.last).toFixed(4)} (qty {qty})</p>
              <button className="btn px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 mt-2" onClick={()=>onPurchase({ ...pick, qty })}>Mark as Purchased</button>
              <button className="btn px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 mt-2 ml-2" onClick={askAI}>Ask ChatGPT about this pick</button>
            </div>
          )}
        </div>
      );
    }

    function Holding({ holding, onClear }){
      async function askAI(){
        const qs = new URLSearchParams({ mode:'holding', symbol:holding.symbol, entry:holding.entry, purchasedAt:holding.purchasedAt });
        const r = await fetch('/.netlify/functions/advice?' + qs.toString());
        const j = await r.json();
        alert('AI holding advice:\\n' + JSON.stringify(j.advice, null, 2));
      }
      return (
        <div className="card p-5 md:p-6 space-y-3">
          <h2 className="text-lg font-semibold">Holding</h2>
          <p>{holding.symbol} @ {holding.entry} (qty {holding.qty})</p>
          <button className="btn px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={askAI}>Ask ChatGPT (Hold/Sell?)</button>
          <button className="btn px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700 ml-2" onClick={onClear}>Clear</button>
        </div>
      );
    }

    function App(){
      const [holding, setHolding] = useLocal('holding', null);

      function handlePurchase(p){
        const newHold = {
          symbol: p.symbol,
          entry: Number(p.last),
          qty: p.qty,
          purchasedAt: new Date().toISOString()
        };
        setHolding(newHold);
      }

      return (
        <div className="max-w-4xl mx-auto p-4 md:p-8 space-y-6">
          <Header/>
          <DailyPick onPurchase={handlePurchase} />
          {holding && <Holding holding={holding} onClear={()=>setHolding(null)} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
