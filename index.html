<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASX AI Weekly — Analyst Picks + Holdings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1020;color:#e2e8f0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.15);border-radius:1rem}
    .glass{background:rgba(255,255,255,.06);border:1px solid rgba(148,163,184,.18);border-radius:.75rem}
    .btn{transition:transform .06s ease}.btn:active{transform:translateY(1px)}
    .muted{color:#94a3b8}.pill{padding:.15rem .5rem;border-radius:.5rem;font-size:.75rem}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API = '/.netlify/functions';
    function feeFor(c){c=Number(c||0);if(c<=1000)return 5;if(c<=3000)return 10;if(c<=10000)return 19.95;if(c<=25000)return 29.95;return 29.95}
    function breakdown(capital, entry){const buy=feeFor(capital),sell=feeFor(capital);const qty=Math.max(0,Math.floor(Number(capital)/Number(entry)));const total=buy+sell;const be=qty>0?(Number(capital)+total)/qty:null;return{qty,buyFee:buy,sellFee:sell,totalFees:total,breakeven:be}}
    function expectedPL(entry, exitPrice, qty, buyFee, sellFee){if(qty<=0||!isFinite(entry)||!isFinite(exitPrice))return null;return (Number(exitPrice)-Number(entry))*Number(qty)-(Number(buyFee)+Number(sellFee))}
    function netTarget(entry, capital, profitPct){const {qty,buyFee,sellFee}=breakdown(capital, entry);if(qty<=0)return null;const requiredNet=Number(capital)*(Number(profitPct)/100);return Number(entry)+ (requiredNet + buyFee + sellFee)/qty}
    function useLocal(k,i){const [v,setV]=useState(()=>{try{const s=localStorage.getItem(k);return s?JSON.parse(s):i}catch{return i}});useEffect(()=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}},[v]);return [v,setV]}
    function fmt(n, d=4){return n!=null?Number(n).toFixed(d):'—'}

    function Header({capital,setCapital,profitPct,setProfitPct,universe,setUniverse}){
      return (<header className="p-6">
        <h1 className="text-2xl md:text-3xl font-semibold">ASX <span className="text-violet-400">AI Weekly Analyst Picks</span> <span className="text-xs text-slate-400">90‑day Yahoo + News + Financials</span></h1>
        <div className="text-slate-300 text-sm mt-2 flex flex-wrap gap-3 items-center">
          <div className="flex items-center gap-2"><span className="muted">Default Capital (AUD):</span><input type="number" min="50" step="1" className="glass px-3 py-2 rounded-md w-40 text-slate-100" value={capital} onChange={e=>setCapital(Math.max(0,Number(e.target.value||0)))} /></div>
          <div className="flex items-center gap-2"><span className="muted">Profit % (net):</span><input type="number" min="1" step="0.1" className="glass px-3 py-2 rounded-md w-28 text-slate-100" value={profitPct} onChange={e=>setProfitPct(Math.max(0,Number(e.target.value||0)))} /></div>
          <div className="flex items-center gap-2"><span className="muted">Universe size:</span>
            <select className="glass px-2 py-2 rounded" value={universe} onChange={e=>setUniverse(e.target.value)}>
              <option value="small">Small (≈24)</option>
              <option value="medium">Medium (≈50)</option>
              <option value="large">Large (≈80)</option>
            </select>
          </div>
          <button className="btn px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={async()=>{try{const r=await fetch(`${API}/advice?mode=ping&t=${Date.now()}`);alert(await r.text())}catch(e){alert('Advice ping failed: '+e.message)}}}>Ping AI</button>
        </div>
      </header>)
    }

    function LivePrice({symbol}){
      const [last,setLast]=useState(null), [err,setErr]=useState(null);
      async function tick(){ try{ const r=await fetch(`/.netlify/functions/market?fn=quote&symbol=${encodeURIComponent(symbol)}&t=${Date.now()}`); const j=await r.json(); if(j.error) throw new Error(j.error); setLast(j.last);} catch(e){setErr(e.message);} }
      useEffect(()=>{ tick(); const id=setInterval(tick,60000); return ()=>clearInterval(id); }, [symbol]);
      return <div className="text-xs">{err? <span className="text-rose-400">live price error</span> : `Live: ${last!=null?Number(last).toFixed(4):'—'}`}</div>;
    }

    function Picks({capital,profitPct,universe,onBuy}){
      const [rows,setRows]=useState([]);
      const [asOf,setAsOf]=useState(null);
      const [err,setErr]=useState(null);
      const [loading,setLoading]=useState(false);

      async function refresh(){
        setErr(null); setLoading(true);
        try{
          const url = `${API}/advice?mode=analyst-weekly&capital=${capital}&profitPct=${profitPct}&universe=${universe}&t=${Date.now()}`;
          const res = await fetch(url);
          const data = await res.json();
          if(data.error) throw new Error(data.error);
          setRows(data.picks||[]);
          setAsOf(data.asOf || null);
        }catch(e){ setErr(e.message); setRows([]); }
        finally{ setLoading(false); }
      }
      useEffect(()=>{ refresh(); }, [capital,profitPct,universe]);

      return (<div className="card p-5 md:p-6 space-y-3">
        <div className="flex items-center justify-between"><div>
          <h2 className="text-lg font-semibold">Top 3 — AI Weekly (Targets · ETA · Confidence)</h2>
          <div className="text-xs text-slate-400">{asOf?`as of ${new Date(asOf).toLocaleString()}`:''}</div>
        </div><button className="btn px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={refresh} disabled={loading}>{loading?'Loading…':'Refresh'}</button></div>
        {err && <p className="text-sm text-rose-400">⚠️ {err}</p>}
        {!err && rows.length===0 && <p className="muted">Finding candidates…</p>}
        <div className="space-y-2">
          {rows.map((p,i)=>{
            const entry = p.entry;
            const bd=breakdown(capital,entry);
            const tgtNet=netTarget(entry,capital,profitPct);
            const stop=entry*0.95;
            const tPL=expectedPL(entry,tgtNet,bd.qty,bd.buyFee,bd.sellFee);
            const sPL=expectedPL(entry,stop,bd.qty,bd.buyFee,bd.sellFee);
            return (<div key={p.symbol} className="glass p-3 rounded-lg space-y-2">
              <div className="flex justify-between items-center">
                <div><span className="font-semibold">#{i+1} {p.symbol}</span> <span className="text-xs text-slate-400">{p.name||''}</span></div>
                <span className="pill bg-white/10">AI {p.aiScore!=null?p.aiScore.toFixed(2):'—'} · Conf {p.confidence!=null?Math.round(p.confidence*100)+'%':'—'}</span>
              </div>
              <LivePrice symbol={p.symbol} />
              <div className="text-sm">Entry {fmt(entry)} · Net Target (+{profitPct}%) {tgtNet!=null ? ' $' + fmt(tgtNet) : ''} · AI Target {p.targetPrice!=null? '$'+fmt(p.targetPrice):'—'} · ETA ~{p.timelineDays??'—'}d</div>
              <div className="text-xs text-slate-300">Fees: buy {bd.buyFee.toFixed(2)} + sell {bd.sellFee.toFixed(2)} = {bd.totalFees.toFixed(2)} · Breakeven {bd.breakeven?fmt(bd.breakeven):'—'}</div>
              <div className="text-xs">Expected P/L at Net Target: <span className={(tPL||0)>=0?'text-emerald-400':'text-rose-400'}>{tPL!=null?`A$${tPL.toFixed(2)}`:'—'}</span> · at Stop: <span className={(sPL||0)>=0?'text-emerald-400':'text-rose-400'}>{sPL!=null?`A$${sPL.toFixed(2)}`:'—'}</span></div>
              <details className="mt-1"><summary className="text-xs cursor-pointer">Rationale & headlines</summary><pre className="mono text-xs bg-black/30 p-3 rounded-lg overflow-auto mt-2">{p.rationale||'—'}</pre></details>
              <div className="flex gap-2 items-center">
                <input id={`amt-${p.symbol}`} className="glass px-3 py-2 rounded-md w-40 text-slate-100" type="number" step="1" min="50" placeholder="Amount to invest (AUD)" />
                <button className="btn px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700" onClick={()=>{
                  const el=document.getElementById(`amt-${p.symbol}`);
                  const amt = Number(el?.value||0)||0;
                  if(amt<=0){ alert('Enter amount (AUD)'); return; }
                  onBuy({ ...p, invested: amt });
                }}>Mark as Purchased</button>
              </div>
            </div>)
          })}
        </div>
      </div>)
    }

    function Holdings({profitPct}){
      const [holds,setHolds]=useLocal('holds',[]);
      async function remove(sym){ setHolds(holds.filter(h=>h.symbol!==sym)); }
      function add(h){ const bd = breakdown(h.invested, h.entry); const qty = bd.qty, buyFee=bd.buyFee, sellFee=bd.sellFee; const aiTarget = h.targetPrice ?? null; const aiETA = h.timelineDays ?? null; const aiConf = h.confidence ?? null; const buyAt = new Date().toISOString(); const save = { symbol:h.symbol, name:h.name, entry:h.entry, invested:h.invested, qty, buyFee, sellFee, aiTarget, aiETA, aiConf, buyAt }; setHolds(prev=>[save, ...prev.filter(x=>x.symbol!==h.symbol)]); }
      window.__addHolding = add;
      return (<div className="card p-5 md:p-6 space-y-3">
        <div className="flex items-center justify-between"><h2 className="text-lg font-semibold">Holdings</h2></div>
        {holds.length===0 && <p className="muted">No holdings yet.</p>}
        <div className="space-y-2">{holds.map(h=> <HoldingRow key={h.symbol} h={h} profitPct={profitPct} onClose={()=>remove(h.symbol)} />)}</div>
      </div>)
    }

    function HoldingRow({h,profitPct,onClose}){
      const [last,setLast]=useState(null);
      async function tick(){ try{ const r=await fetch(`/.netlify/functions/market?fn=quote&symbol=${encodeURIComponent(h.symbol)}&t=${Date.now()}`); const j=await r.json(); setLast(j.last);}catch{} }
      useEffect(()=>{ tick(); const id=setInterval(tick,60000); return ()=>clearInterval(id); }, [h.symbol]);
      const netTargetPrice = netTarget(h.entry, h.invested, profitPct) ?? null;
      const qty = h.qty;
      const buyFee=h.buyFee, sellFee=h.sellFee;
      const trail = h.entry * 1.015;
      const suggestedSell = Math.max(netTargetPrice||0, h.aiTarget||0, trail);
      const now = Date.now(), start = Date.parse(h.buyAt||new Date().toISOString());
      const elapsedDays = (now - start)/(1000*3600*24);
      const eta = h.aiETA ?? 5;
      const progress = Math.min(100, Math.max(0, Math.round((elapsedDays/eta)*100)));
      const plNow = (last!=null && qty>0) ? (last-h.entry)*qty - (buyFee+sellFee) : null;

      return (<div className="glass p-3 rounded-lg space-y-1">
        <div className="flex justify-between items-center">
          <div><span className="font-semibold">{h.symbol}</span> <span className="text-xs text-slate-400">{h.name||''}</span></div>
          <button className="btn px-2 py-1 rounded bg-rose-700 hover:bg-rose-800" onClick={onClose}>Remove</button>
        </div>
        <div className="text-xs">Bought: {new Date(h.buyAt).toLocaleString()} · Entry {fmt(h.entry)} · Qty {qty} · Fees (buy+sell) {(buyFee+sellFee).toFixed(2)}</div>
        <div className="text-xs">Live: {last!=null?fmt(last):'—'} · Net Target {netTargetPrice!=null?fmt(netTargetPrice):'—'} · AI Target {h.aiTarget!=null?fmt(h.aiTarget):'—'} · Suggest Sell @ {fmt(suggestedSell)}</div>
        <div className="text-xs">ETA: {h.aiETA??'—'} days · Progress: {progress}% · AI Confidence: {h.aiConf!=null?Math.round(h.aiConf*100)+'%':'—'}</div>
        <div className="text-xs">P/L now (net est): {plNow!=null? (plNow>=0?`+A$${plNow.toFixed(2)}`:`-A$${Math.abs(plNow).toFixed(2)}`):'—'}</div>
      </div>)
    }

    function App(){
      const [capital,setCapital]=useLocal('capital',1000);
      const [profitPct,setProfitPct]=useLocal('profitPct',7.5);
      const [universe,setUniverse]=useLocal('universe','small');
      function onBuy(p){ if(window.__addHolding) window.__addHolding(p); }
      return (<div className="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
        <Header capital={capital} setCapital={setCapital} profitPct={profitPct} setProfitPct={setProfitPct} universe={universe} setUniverse={setUniverse} />
        <Picks capital={capital} profitPct={profitPct} universe={universe} onBuy={onBuy} />
        <Holdings profitPct={profitPct} />
        <footer className="py-8 text-center text-slate-500 text-xs">Educational tool. Uses Yahoo Finance (90‑day history + live quotes), Google News headlines, and OpenAI for weekly analysis.</footer>
      </div>)
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
