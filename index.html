<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASX Swing Trader (Yahoo)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #0b1020; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: #e2e8f0; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(148,163,184,0.15); border-radius: 1rem; }
    .glass { background: rgba(255,255,255,0.06); border: 1px solid rgba(148,163,184,0.18); border-radius: .75rem; }
    .btn { transition: transform .06s ease; } .btn:active{ transform: translateY(1px); }
    table { width: 100%; border-collapse: collapse; } th, td { padding: .5rem .6rem; }
    thead th { text-align: left; font-weight: 600; color: #cbd5e1; }
    tbody tr { border-top: 1px solid rgba(148,163,184,0.18); }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const API_BASE = '/.netlify/functions/yf';
    const fmt = new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' });
    const pct = (n) => (n == null || isNaN(n) ? '—' : `${n.toFixed(2)}%`);

    // Common ASX tickers to seed a candidates list (edit to taste)
    const ASX_WATCHLIST = [
      'BHP','RIO','FMG','CSL','CBA','NAB','WBC','ANZ','MQG','WES','WOW','TLS','QAN','TCL','GMG','COL','WDS','ORG','BXB','ALL',
      'PLS','LKE','CXO','IGO','MIN','S32','NST','EVN','CHN','SYA','ZIP','BNPL','XRO','APT','SQ2','SEK','REA','CAR','TPG','PME','RHC'
    ];

    function normalizeSymbol(input){
      if(!input) return '';
      let s = String(input).trim().toUpperCase();
      if (!s.includes('.AX')) s = s + '.AX'; // Yahoo uses .AX
      return s;
    }

    async function fetchQuote(symbols){
      // symbols: array of 'XYZ.AX'
      const qs = encodeURIComponent(symbols.join(','));
      const res = await fetch(`${API_BASE}?fn=quote&symbols=${qs}`);
      return res.json();
    }

    async function fetchSpark(symbols, range='1mo', interval='1d'){
      const qs = encodeURIComponent(symbols.join(','));
      const res = await fetch(`${API_BASE}?fn=spark&symbols=${qs}&range=${range}&interval=${interval}`);
      return res.json();
    }

    function computeBands(entry, tpPct=8, slPct=5){
      if (!entry) return { target: null, stop: null };
      return { target: entry*(1+tpPct/100), stop: entry*(1-slPct/100) };
    }

    function decision({ last, entry, tpPct, slPct }){
      if (!last || !entry) return { action: '—', reason: 'Enter ticker and entry price' };
      const { target, stop } = computeBands(entry, tpPct, slPct);
      if (last <= stop) return { action: 'SELL', reason: `Price ≤ stop (${last.toFixed(4)} ≤ ${stop.toFixed(4)})` };
      if (last >= target) return { action: 'TAKE PROFIT', reason: `Price ≥ target (${last.toFixed(4)} ≥ ${target.toFixed(4)})` };
      return { action: 'HOLD', reason: `Between stop ${stop.toFixed(4)} and target ${target.toFixed(4)}` };
    }

    function useLocalStorage(key, initial){
      const [v,setV]=React.useState(()=>{
        try{ const s=localStorage.getItem(key); return s?JSON.parse(s):initial; }catch{ return initial; }
      });
      useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(v)); }catch{} }, [v]);
      return [v,setV];
    }

    function Header(){
      return (
        <header className="p-6">
          <h1 className="text-2xl md:text-3xl font-semibold">ASX Swing Trader <span className="text-violet-400">· Yahoo</span></h1>
          <p className="text-slate-400 text-sm mt-1">Rules: one $1k position · +8% TP · −5% SL · ≈1% round‑trip fee</p>
        </header>
      );
    }

    function Position({ settings, pos, setPos }){
      const [last, setLast] = useState(null);
      const [err, setErr] = useState(null);
      const [loading, setLoading] = useState(false);

      const sym = normalizeSymbol(pos.ticker);
      const bands = computeBands(pos.entryPrice, settings.tpPct, settings.slPct);
      const call = decision({ last, entry: pos.entryPrice, tpPct: settings.tpPct, slPct: settings.slPct });

      async function refresh(){
        setErr(null); setLoading(true);
        try{
          if(!sym) throw new Error('Enter a ticker like PLS.AX');
          const q = await fetchQuote([sym]);
          if(q?.error) throw new Error(q.error);
          const row = q?.quoteResponse?.result?.[0];
          if(!row) throw new Error('No data for symbol.');
          setLast(row.regularMarketPrice);
        }catch(e){
          setErr(e.message); setLast(null);
        }finally{ setLoading(false); }
      }

      useEffect(()=>{ if(sym) refresh(); }, [sym]);

      return (
        <div className="card p-5 md:p-6 space-y-3">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold">Current Position</h2>
            <button className="btn px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={refresh} disabled={loading}>{loading?'Loading…':'Refresh'}</button>
          </div>

          <div className="grid md:grid-cols-5 gap-3">
            <input className="glass px-3 py-2" placeholder="Ticker (e.g., PLS or PLS.AX)"
                   value={pos.ticker} onChange={e=>setPos({...pos, ticker:e.target.value})}/>
            <input type="number" step="0.0001" className="glass px-3 py-2" placeholder="Entry (e.g., 2.310)"
                   value={pos.entryPrice} onChange={e=>setPos({...pos, entryPrice: Number(e.target.value)})}/>
            <div className="glass px-3 py-2 flex items-center">Last: {last?.toFixed(4) ?? '—'}</div>
            <div className="glass px-3 py-2 flex items-center">Decision: <span className={"ml-2 " + (call.action==='SELL'?'text-rose-400':call.action==='TAKE PROFIT'?'text-emerald-400':'text-sky-300')}>{call.action}</span></div>
            <div className="glass px-3 py-2 flex items-center">Reason: {call.reason}</div>
          </div>

          {bands.target && <p className="text-slate-400 text-sm">TP: {bands.target.toFixed(4)} · SL: {bands.stop.toFixed(4)}</p>}
          {err && <p className="text-sm text-rose-400">⚠️ {err}</p>}
        </div>
      );
    }

    function Candidates({ settings, onPick }){
      const [rows, setRows] = useState([]);
      const [err, setErr] = useState(null);
      const [loading, setLoading] = useState(false);

      async function refresh(){
        setErr(null); setLoading(true);
        try{
          const syms = ASX_WATCHLIST.map(normalizeSymbol);
          const quotes = await fetchQuote(syms);
          const qmap = new Map();
          for(const r of (quotes?.quoteResponse?.result||[])){
            qmap.set(r.symbol, r);
          }
          // Get spark to compute 1w/1m changes
          const spark = await fetchSpark(syms, '1mo', '1d');
          const smap = new Map();
          for(const s of (spark?.spark?.result||[])){
            smap.set(s.symbol, s);
          }
          function computeChange(symbol, days){
            const s = smap.get(symbol);
            if(!s || !s.response || !s.response[0] || !s.response[0].indicators) return null;
            const closes = s.response[0].indicators.quote[0].close || [];
            // find last non-null close and a value ~days ago
            const lastClose = [...closes].reverse().find(v=>v!=null);
            if(lastClose==null) return null;
            let idx = closes.length-1;
            while(idx>=0 && closes[idx]==null) idx--;
            const backIdx = Math.max(0, idx - days);
            // walk back to non-null
            let back = closes[backIdx];
            let j = backIdx;
            while(j>0 && (back==null)) { j--; back = closes[j]; }
            if(back==null) return null;
            return (lastClose/back - 1) * 100;
          }
          const out = [];
          for(const sym of syms){
            const r = qmap.get(sym);
            if(!r) continue;
            const d = r.regularMarketChangePercent;
            const w = computeChange(sym, 5);
            const m = computeChange(sym, 22);
            const score = (d||0) + 0.5*(w||0) + 0.25*(m||0) - (r.marketCap>5e9?1.25:(r.marketCap>1e9?0.5:0));
            out.push({
              Symbol: r.symbol,
              Name: r.shortName || r.longName,
              Last: r.regularMarketPrice,
              DailyPct: d,
              WeeklyPct: w,
              MonthlyPct: m,
              MarketCap: r.marketCap,
              _score: score
            });
          }
          out.sort((a,b)=> (b._score||-1e9) - (a._score||-1e9));
          setRows(out.slice(0, 40));
        }catch(e){
          setErr(e.message); setRows([]);
        }finally{ setLoading(false); }
      }

      useEffect(()=>{ refresh(); }, [settings.tpPct, settings.slPct]);

      return (
        <div className="card p-5 md:p-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-semibold">Top Candidates</h2>
            <button className="btn px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={refresh} disabled={loading}>{loading?'Loading…':'Refresh'}</button>
          </div>
          {err && <p className="text-sm text-rose-400 mb-2">⚠️ {err}</p>}
          <div className="overflow-auto">
            <table className="text-sm">
              <thead>
                <tr><th>Symbol</th><th>Name</th><th style={{textAlign:'right'}}>Last</th><th style={{textAlign:'right'}}>Daily%</th><th style={{textAlign:'right'}}>Weekly%</th><th style={{textAlign:'right'}}>Monthly%</th><th style={{textAlign:'right'}}>Pick</th></tr>
              </thead>
              <tbody>
                {rows.map(r=> (
                  <tr key={r.Symbol} className="hover:bg-white/5">
                    <td>{r.Symbol}</td>
                    <td>{r.Name||'—'}</td>
                    <td style={{textAlign:'right'}}>{r.Last?.toFixed(4)}</td>
                    <td style={{textAlign:'right'}} className={r.DailyPct>=0?'text-emerald-400':'text-rose-400'}>{pct(r.DailyPct||0)}</td>
                    <td style={{textAlign:'right'}} className={r.WeeklyPct>=0?'text-emerald-400':'text-rose-400'}>{pct(r.WeeklyPct||0)}</td>
                    <td style={{textAlign:'right'}} className={r.MonthlyPct>=0?'text-emerald-400':'text-rose-400'}>{pct(r.MonthlyPct||0)}</td>
                    <td style={{textAlign:'right'}}>
                      <button className="btn px-2 py-1 rounded bg-violet-500 hover:bg-violet-600" onClick={()=>onPick(r)}>Select</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function Suggestion({ pick, settings, onCommit }){
      if(!pick) return null;
      const stop = pick.Last * (1 - settings.slPct/100);
      const target = pick.Last * (1 + settings.tpPct/100);
      return (
        <div className="card p-5 md:p-6">
          <h2 className="text-lg font-semibold mb-2">Suggested Trade</h2>
          <div className="grid md:grid-cols-4 gap-3">
            <div className="glass px-3 py-2"><div className="text-slate-400 text-sm">Symbol</div><div className="text-xl font-semibold">{pick.Symbol}</div></div>
            <div className="glass px-3 py-2"><div className="text-slate-400 text-sm">Entry (Last)</div><div className="text-xl font-semibold">{pick.Last?.toFixed(4)}</div></div>
            <div className="glass px-3 py-2"><div className="text-slate-400 text-sm">Stop (−{settings.slPct}%)</div><div className="text-xl font-semibold">{stop.toFixed(4)}</div></div>
            <div className="glass px-3 py-2"><div className="text-slate-400 text-sm">Target (+{settings.tpPct}%)</div><div className="text-xl font-semibold">{target.toFixed(4)}</div></div>
          </div>
          <div className="mt-4 flex gap-2">
            <button className="btn px-3 py-2 rounded bg-emerald-500 hover:bg-emerald-600" onClick={()=>onCommit(pick)}>Commit as Current</button>
          </div>
        </div>
      );
    }

    function App(){
      const [settings, setSettings] = useLocalStorage('settings', { tpPct:8, slPct:5 });
      const [pos, setPos] = useLocalStorage('position', { ticker:'', entryPrice:0 });
      const [pick, setPick] = useState(null);

      function commit(p){
        setPos({ ticker: p.Symbol, entryPrice: p.Last });
        setPick(null);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      return (
        <div className="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
          <Header />
          <Position settings={settings} pos={pos} setPos={setPos} />
          <Candidates settings={settings} onPick={setPick} />
          <Suggestion pick={pick} settings={settings} onCommit={commit} />
          <footer className="py-8 text-center text-slate-500 text-xs">Built for educational purposes. Not financial advice.</footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
