<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASX AI Weekly — Top 3 (90‑day Yahoo + Net Targets)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1020;color:#e2e8f0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.15);border-radius:1rem}
    .glass{background:rgba(255,255,255,.06);border:1px solid rgba(148,163,184,.18);border-radius:.75rem}
    .btn{transition:transform .06s ease}.btn:active{transform:translateY(1px)}
    .muted{color:#94a3b8}.pill{padding:.15rem .5rem;border-radius:.5rem;font-size:.75rem}
    input,select,button{outline:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API = '/.netlify/functions';
    function feeFor(c){c=Number(c||0);if(c<=1000)return 5;if(c<=3000)return 10;if(c<=10000)return 19.95;if(c<=25000)return 29.95;return 29.95}
    function breakdown(capital, entry){const buy=feeFor(capital),sell=feeFor(capital);const qty=Math.max(0,Math.floor(Number(capital)/Number(entry)));const total=buy+sell;const be=qty>0?(Number(capital)+total)/qty:null;return{qty,buyFee:buy,sellFee:sell,totalFees:total,breakeven:be}}
    function expectedPL(entry, exitPrice, qty, buyFee, sellFee){if(qty<=0||!isFinite(entry)||!isFinite(exitPrice))return null;return (Number(exitPrice)-Number(entry))*Number(qty)-(Number(buyFee)+Number(sellFee))}
    function netTarget(entry, capital, profitPct){const {qty,buyFee,sellFee}=breakdown(capital, entry);if(qty<=0)return null;const requiredNet=Number(capital)*(Number(profitPct)/100);return Number(entry)+ (requiredNet + buyFee + sellFee)/qty}
    function useLocal(k,i){const [v,setV]=useState(()=>{try{const s=localStorage.getItem(k);return s?JSON.parse(s):i}catch{return i}});useEffect(()=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}},[v]);return [v,setV]}

    function Header({capital,setCapital,profitPct,setProfitPct,mode,setMode,refreshing,onRefresh}){
      return (<header className="p-6">
        <h1 className="text-2xl md:text-3xl font-semibold">ASX <span className="text-violet-400">AI Weekly Picks</span> <span className="text-xs text-slate-400">90‑day Yahoo data → ChatGPT → Top 3</span></h1>
        <div className="text-slate-300 text-sm mt-2 flex flex-wrap gap-3 items-center">
          <div className="flex items-center gap-2"><span className="muted">Capital (AUD):</span><input type="number" min="50" step="1" className="glass px-3 py-2 rounded-md w-40 text-slate-100" value={capital} onChange={e=>setCapital(Math.max(0,Number(e.target.value||0)))} /></div>
          <div className="flex items-center gap-2"><span className="muted">Profit % (net):</span><input type="number" min="1" step="0.1" className="glass px-3 py-2 rounded-md w-28 text-slate-100" value={profitPct} onChange={e=>setProfitPct(Math.max(0,Number(e.target.value||0)))} /></div>
          <div className="flex items-center gap-2"><span className="muted">Mode:</span>
            <select className="glass px-2 py-2 rounded" value={mode} onChange={e=>setMode(e.target.value)}>
              <option value="ai-weekly">AI Weekly (90d)</option>
              <option value="raw">Raw Candidates</option>
            </select>
          </div>
          <button className="btn px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-700" onClick={onRefresh} disabled={refreshing}>{refreshing?'Loading…':'Refresh'}</button>
          <span className="muted text-xs">Not financial advice</span>
        </div>
      </header>)
    }

    function Picks({capital,profitPct,mode}){
      const [rows,setRows]=useState([]);
      const [asOf,setAsOf]=useState(null);
      const [err,setErr]=useState(null);
      const [loading,setLoading]=useState(false);

      async function refresh(){
        setErr(null); setLoading(true);
        try{
          const url = mode==='ai-weekly' ? `${API}/advice?mode=ai-weekly&capital=${capital}&profitPct=${profitPct}&t=${Date.now()}`
                                         : `${API}/market?fn=candidates&t=${Date.now()}`;
          const res = await fetch(url);
          const data = await res.json();
          if(data.error) throw new Error(data.error);
          const list = mode==='ai-weekly' ? (data.picks||[]) : (data.candidates||[]).slice(0,3);
          setRows(list);
          setAsOf(data.asOf || new Date().toISOString());
        }catch(e){ setErr(e.message); setRows([]); }
        finally{ setLoading(false); }
      }
      useEffect(()=>{ refresh(); }, [mode]);

      return (<div className="card p-5 md:p-6 space-y-3">
        <div className="flex items-center justify-between"><div>
          <h2 className="text-lg font-semibold">{mode==='ai-weekly'?'Top 3 — AI Weekly from 90‑day Yahoo':'Raw candidates (first 3)'}</h2>
          <div className="text-xs text-slate-400">{asOf?`as of ${new Date(asOf).toLocaleString()}`:''}</div>
        </div>
        <button className="btn px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={refresh} disabled={loading}>{loading?'Loading…':'Refresh'}</button></div>
        {err && <p className="text-sm text-rose-400">⚠️ {err}</p>}
        {!err && rows.length===0 && <p className="muted">Finding candidates…</p>}
        <div className="space-y-2">
          {rows.map((p,i)=>{
            const entry = p.entry ?? p.last;
            const bd=breakdown(capital,entry);
            const tgt=netTarget(entry,capital,profitPct);
            const stop=entry*0.95;
            const tPL=expectedPL(entry,tgt,bd.qty,bd.buyFee,bd.sellFee);
            const sPL=expectedPL(entry,stop,bd.qty,bd.buyFee,bd.sellFee);
            return (<div key={p.symbol} className="glass p-3 rounded-lg space-y-1">
              <div className="flex justify-between items-center">
                <div><span className="font-semibold">#{i+1} {p.symbol}</span> <span className="text-xs text-slate-400">{p.name||''}</span></div>
                <span className="pill bg-white/10">{p.aiScore!=null?`AI ${p.aiScore.toFixed(2)}`:(p.score!=null?`Score ${p.score.toFixed(2)}`:'')}</span>
              </div>
              <LivePrice symbol={p.symbol} />
              <div className="text-sm">Entry {entry?.toFixed?.(4)} · Target (net +{profitPct}%) {tgt!=null ? ' $' + tgt.toFixed(4) : ''} · Stop {stop.toFixed(4)} · Qty @ A$ {capital}: {bd.qty}</div>
              <div className="text-xs text-slate-300">Fees: buy {bd.buyFee.toFixed(2)} + sell {bd.sellFee.toFixed(2)} = {bd.totalFees.toFixed(2)} · Breakeven {bd.breakeven?bd.breakeven.toFixed(4):'—'}</div>
              <div className="text-xs">Expected P/L at Target: <span className={(tPL||0)>=0?'text-emerald-400':'text-rose-400'}>{tPL!=null?`A$${tPL.toFixed(2)}`:'—'}</span> · at Stop: <span className={(sPL||0)>=0?'text-emerald-400':'text-rose-400'}>{sPL!=null?`A$${sPL.toFixed(2)}`:'—'}</span></div>
              {p.rationale && <pre className="mono text-xs bg-black/30 p-3 rounded-lg overflow-auto mt-2">{p.rationale}</pre>}
            </div>)
          })}
        </div>
      </div>)
    }

    function LivePrice({symbol}){
      const [last,setLast]=useState(null), [err,setErr]=useState(null);
      async function tick(){ try{ const r=await fetch(`/.netlify/functions/market?fn=quote&symbol=${encodeURIComponent(symbol)}&t=${Date.now()}`); const j=await r.json(); if(j.error) throw new Error(j.error); setLast(j.last);} catch(e){setErr(e.message);} }
      useEffect(()=>{ tick(); const id=setInterval(tick,60000); return ()=>clearInterval(id); }, [symbol]);
      return <div className="text-xs">{err? <span className="text-rose-400">live price error</span> : `Live: ${last!=null?Number(last).toFixed(4):'—'}`}</div>;
    }

    function App(){
      const [capital,setCapital]=useLocal('capital',1000);
      const [profitPct,setProfitPct]=useLocal('profitPct',7.5);
      const [mode,setMode]=useLocal('mode','ai-weekly');
      const [refreshing,setRefreshing]=useState(false);
      return (<div className="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
        <Header capital={capital} setCapital={setCapital} profitPct={profitPct} setProfitPct={setProfitPct} mode={mode} setMode={setMode} refreshing={refreshing} onRefresh={()=>setRefreshing(s=>!s)} />
        <Picks key={mode+'-'+capital+'-'+profitPct+'-'+refreshing} capital={capital} profitPct={profitPct} mode={mode} />
        <footer className="py-8 text-center text-slate-500 text-xs">Education only. This app uses Yahoo Finance for 90‑day history and live quotes; ChatGPT ranks weekly picks server‑side.</footer>
      </div>)
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
