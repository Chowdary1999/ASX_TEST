<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASX Swing Trader — Top 3 (AI + Tracking + Fees)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1020;color:#e2e8f0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.15);border-radius:1rem}
    .glass{background:rgba(255,255,255,.06);border:1px solid rgba(148,163,184,.18);border-radius:.75rem}
    .btn{transition:transform .06s ease}.btn:active{transform:translateY(1px)}
    .muted{color:#94a3b8}.pill{padding:.15rem .5rem;border-radius:.5rem;font-size:.75rem}
    .row{border-top:1px dashed rgba(148,163,184,.2);padding-top:.5rem;margin-top:.5rem}
    input,select,button{outline:none}
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API = '/.netlify/functions/market';
    const AI = '/.netlify/functions/advice';

    // ---- CommSec fees ----
    function feeFor(c){
      c = Number(c||0);
      if (c <= 1000) return 5.00;
      if (c <= 3000) return 10.00;
      if (c <= 10000) return 19.95;
      if (c <= 25000) return 29.95;
      return 29.95;
    }

    function breakdown(capital, entry){
      const buyFee = feeFor(capital);
      const sellFee = feeFor(capital);
      const qty = Math.max(0, Math.floor(Number(capital)/Number(entry)));
      const invested = qty * Number(entry) + buyFee;
      const totalFees = buyFee + sellFee;
      const breakeven = qty>0 ? (Number(capital)+totalFees)/qty : null;
      return { qty, buyFee, sellFee, totalFees, invested, breakeven };
    }

    function expectedPL(entry, exitPrice, qty, buyFee, sellFee){
      if (qty<=0 || !isFinite(entry) || !isFinite(exitPrice)) return null;
      return (Number(exitPrice) - Number(entry)) * Number(qty) - (Number(buyFee) + Number(sellFee));
    }

    // Target that nets desired profit% on given capital after fees
    function netTarget(entry, capital, profitPct){
      const { qty, buyFee, sellFee } = breakdown(capital, entry);
      if (qty<=0) return null;
      const requiredNet = Number(capital) * (Number(profitPct)/100);
      return Number(entry) + (requiredNet + buyFee + sellFee) / qty;
    }

    function useLocal(key, init){
      const [v,setV] = React.useState(()=>{
        try{ const s = localStorage.getItem(key); return s?JSON.parse(s):init; }catch{return init;}
      });
      useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(v)); }catch{} }, [v]);
      return [v,setV];
    }

    function Header({ capital, setCapital, profitPct, setProfitPct }){ 
      return (
      <header className="p-6">
        <h1 className="text-2xl md:text-3xl font-semibold">ASX Swing Trader <span className="text-violet-400">· top 3 picks</span></h1>
        <div className="text-slate-300 text-sm mt-2 flex flex-wrap gap-4 items-center">
          <div className="flex items-center gap-2">
            <label className="muted">Default capital (AUD):</label>
            <input type="number" min="50" step="1" className="glass px-3 py-2 rounded-md w-40 text-slate-100"
                  value={capital} onChange={e=>setCapital(Math.max(0, Number(e.target.value||0)))} />
          </div>
          <div className="flex items-center gap-2">
            <label className="muted">Profit % (net):</label>
            <input type="number" min="1" step="0.1" className="glass px-3 py-2 rounded-md w-28 text-slate-100"
                  value={profitPct} onChange={e=>setProfitPct(Math.max(0, Number(e.target.value||0)))} />
          </div>
          <span className="muted text-xs">CommSec fees auto-applied · buy + sell</span>
        </div>
      </header>
    );}

    function ErrorLine({msg}){ if(!msg) return null; return <p className="text-sm text-rose-400">⚠️ {msg}</p>; }

    function Top3({ onPurchase, capital, profitPct }){
      const [picks,setPicks]=useState([]);
      const [asOf,setAsOf]=useState(null);
      const [err,setErr]=useState(null);
      const [loading,setLoading]=useState(false);
      const [open,setOpen]=useState({});
      const [amt,setAmt]=useState({});
      const [refreshMins,setRefreshMins]=useLocal('refreshMins',5);

      async function refresh(){
        setErr(null); setLoading(true);
        try{
          const res = await fetch(`${API}?fn=pick3&t=${Date.now()}`);
          const data = await res.json();
          if(data.error) throw new Error(data.error);
          setPicks(data.picks||[]);
          setAsOf(data.asOf || null);
        }catch(e){ setErr(e.message); setPicks([]); }
        finally{ setLoading(false); }
      }
      useEffect(()=>{ refresh(); }, []);
      useEffect(()=>{ let id=null; const m=Number(refreshMins||0); if(m>0){ id=setInterval(()=>refresh(), m*60*1000);} return ()=>id&&clearInterval(id);}, [refreshMins]);

      function toggle(sym){ setOpen(o=>({...o,[sym]:!o[sym]})); setAmt(a=>({...a,[sym]:a[sym]??capital})); }
      function confirm(p){ const a=Number(amt[p.symbol]); if(!isFinite(a)||a<=0){alert('Enter a valid amount');return;} const bd=breakdown(a,p.entry); onPurchase({...p,capital:a,qty:bd.qty,buyFee:bd.buyFee,sellFee:bd.sellFee,breakeven:bd.breakeven}); setOpen(o=>({...o,[p.symbol]:false})); }

      return (
        <div className="card p-5 md:p-6 space-y-3">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-lg font-semibold">Top 3 Daily Picks</h2>
              <div className="text-xs text-slate-400">{asOf?`as of ${new Date(asOf).toLocaleString()}`:''}</div>
            </div>
            <div className="flex gap-2 items-center">
              <span className="muted text-xs">Auto-refresh:</span>
              <select className="glass px-2 py-1 rounded" value={refreshMins} onChange={e=>setRefreshMins(Number(e.target.value))}>
                <option value={1}>1 min</option>
                <option value={5}>5 min</option>
                <option value={15}>15 min</option>
                <option value={0}>Off</option>
              </select>
              <button className="btn px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={refresh} disabled={loading}>{loading?'Loading…':'Refresh'}</button>
            </div>
          </div>
          <ErrorLine msg={err}/>
          {picks.length===0 && !err && <p className="muted text-sm">Finding candidates…</p>}
          <div className="space-y-2">
            {picks.map(p=>{
              const bd=breakdown(capital,p.entry);
              const tgt = netTarget(p.entry, capital, profitPct);
              const stop = p.entry*0.95;
              const tPL=expectedPL(p.entry,tgt,bd.qty,bd.buyFee,bd.sellFee);
              const sPL=expectedPL(p.entry,stop,bd.qty,bd.buyFee,bd.sellFee);
              const isOpen=!!open[p.symbol];
              const curAmt=amt[p.symbol]??capital;
              const bd2=breakdown(curAmt,p.entry);
              const tgt2 = netTarget(p.entry, curAmt, profitPct);
              const tPL2=expectedPL(p.entry,tgt2,bd2.qty,bd2.buyFee,bd2.sellFee);
              const sPL2=expectedPL(p.entry,stop,bd2.qty,bd2.buyFee,bd2.sellFee);
              return (
                <div key={p.symbol} className="glass p-3 rounded-lg space-y-1">
                  <div className="flex justify-between items-center">
                    <div><span className="font-semibold">#{p.rank} {p.symbol}</span> <span className="text-xs text-slate-400">{p.name||''}</span></div>
                    <span className="pill bg-white/10">Score {p.score?.toFixed?.(2)??'—'}</span>
                  </div>
                  <div className="text-sm">Entry {p.entry?.toFixed?.(4)} · Target (net +{profitPct}%){tgt?`: ${tgt.toFixed(4)}`:''} · Stop {stop.toFixed(4)} · Qty @ A${capital}: {bd.qty}</div>
                  <div className="text-xs text-slate-300">Capital A${capital} · Buy Fee A${bd.buyFee.toFixed(2)} · Sell Fee A${bd.sellFee.toFixed(2)} · Total Fees A${bd.totalFees.toFixed(2)} · Break-even {bd.breakeven?bd.breakeven.toFixed(4):'—'}</div>
                  <div className="text-xs">Expected P/L at Target: <span className={(tPL||0)>=0?'text-emerald-400':'text-rose-400'}>{tPL!=null?`A$${tPL.toFixed(2)}`:'—'}</span> · at Stop: <span className={(sPL||0)>=0?'text-emerald-400':'text-rose-400'}>{sPL!=null?`A$${sPL.toFixed(2)}`:'—'}</span></div>
                  <div className="flex gap-2"><button className="btn mt-1 px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-600" onClick={()=>toggle(p.symbol)}>{isOpen?'Cancel':'Mark as Purchased'}</button></div>
                  {isOpen && (
                    <div className="row">
                      <div className="flex items-center gap-2">
                        <span className="muted text-xs">Amount to invest (AUD):</span>
                        <input type="number" min="50" step="1" className="glass px-3 py-1 rounded-md w-32 text-slate-100" value={curAmt} onChange={e=>setAmt(a=>({...a,[p.symbol]:Math.max(0,Number(e.target.value||0))}))} />
                        <button className="btn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700" onClick={()=>confirm(p)}>Confirm Purchase</button>
                      </div>
                      <div className="text-xs text-slate-300 mt-1">Qty {bd2.qty} · Buy Fee A${bd2.buyFee.toFixed(2)} · Sell Fee A${bd2.sellFee.toFixed(2)} · Total Fees A${bd2.totalFees.toFixed(2)} · Break-even {bd2.breakeven?bd2.breakeven.toFixed(4):'—'}</div>
                      <div className="text-xs mt-1">Target (net +{profitPct}%){tgt2?`: ${tgt2.toFixed(4)}`:''} · Expected P/L at Target: <span className={(tPL2||0)>=0?'text-emerald-400':'text-rose-400'}>{tPL2!=null?`A$${tPL2.toFixed(2)}`:'—'}</span> · at Stop: <span className={(sPL2||0)>=0?'text-emerald-400':'text-rose-400'}>{sPL2!=null?`A$${sPL2.toFixed(2)}`:'—'}</span></div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function Holding({ holding, profitPct, onClear }){
      const [last,setLast]=useState(null);
      const [hi,setHi]=useState(null);
      const [err,setErr]=useState(null);
      const [loading,setLoading]=useState(false);

      async function refresh(){
        setErr(null); setLoading=true;
        try{
          const qs = new URLSearchParams({ fn:'since', symbol: holding.symbol, from: holding.purchasedAt });
          const r = await fetch(`${API}?`+qs.toString());
          const j = await r.json();
          if(j.error) throw new Error(j.error);
          setLast(j.last); setHi(j.highSince);
        }catch(e){ setErr(e.message); setLast(null); setHi(null); }
        finally{ setLoading(false); }
      }
      useEffect(()=>{ refresh(); }, [holding.symbol, holding.purchasedAt]);

      const entry = Number(holding.entry);
      const qty = Number(holding.qty);
      const capital = Number(holding.capital);
      const buyFee = Number(holding.buyFee);
      const sellFee = Number(holding.sellFee);
      const stop = entry * 0.95;
      const tgt = netTarget(entry, capital, profitPct);
      const trail = (hi!=null) ? hi * 0.985 : null; // keep trailing logic as a safety
      const suggested = trail!=null ? Math.max(tgt??0, trail) : (tgt??entry);
      const pnlGross = (last!=null) ? (last - entry) * qty : null;
      const pnlNet = (pnlGross!=null) ? pnlGross - (buyFee + sellFee) : null;
      const breakeven = holding.breakeven ?? ((capital + buyFee + sellFee) / qty);
      const plT = expectedPL(entry, tgt, qty, buyFee, sellFee);
      const plS = expectedPL(entry, stop, qty, buyFee, sellFee);

      return (
        <div className="card p-5 md:p-6 space-y-3">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold">Holding</h2>
            <div className="flex gap-2">
              <span className="pill bg-white/10">Qty {qty}</span>
              <button className="btn px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600" onClick={refresh} disabled={loading}>{loading?'Loading…':'Refresh'}</button>
              <button className="btn px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700" onClick={onClear}>Clear</button>
            </div>
          </div>
          <div className="grid md:grid-cols-6 gap-3">
            <div className="glass px-3 py-2"><div className="muted text-sm">Symbol</div><div className="text-xl font-semibold">{holding.symbol}</div></div>
            <div className="glass px-3 py-2"><div className="muted text-sm">Entry</div><div className="text-xl font-semibold">{entry.toFixed(4)}</div></div>
            <div className="glass px-3 py-2"><div className="muted text-sm">Last</div><div className="text-xl font-semibold">{(last!=null)?Number(last).toFixed(4):'—'}</div></div>
            <div className="glass px-3 py-2"><div className="muted text-sm">High since buy</div><div className="text-xl font-semibold">{(hi!=null)?Number(hi).toFixed(4):'—'}</div></div>
            <div className="glass px-3 py-2"><div className="muted text-sm">Suggested Sell</div><div className="text-xl font-semibold">{Number(suggested).toFixed(4)}</div><div className="muted text-xs">net +{profitPct}% or trail 1.5%</div></div>
            <div className="glass px-3 py-2"><div className="muted text-sm">P/L (net est.)</div><div className={"text-xl font-semibold "+((pnlNet||0)>=0?'text-emerald-400':'text-rose-400')}>{(pnlNet!=null)?('A$'+pnlNet.toFixed(2)):'—'}</div></div>
          </div>
          <div className="text-xs text-slate-300">
            Capital A${capital} · Buy Fee A${buyFee.toFixed(2)} · Sell Fee A${sellFee.toFixed(2)} · Total Fees A${(buyFee+sellFee).toFixed(2)} · Break-even {breakeven?breakeven.toFixed(4):'—'}
          </div>
          <div className="text-xs">
            Target (net +{profitPct}%){tgt?`: ${tgt.toFixed(4)}`:''} · Expected P/L at Target: <span className={(plT||0)>=0?'text-emerald-400':'text-rose-400'}>{plT!=null?`A$${plT.toFixed(2)}`:'—'}</span> ·
            at Stop: <span className={(plS||0)>=0?'text-emerald-400':'text-rose-400'}>{plS!=null?`A$${plS.toFixed(2)}`:'—'}</span>
          </div>
          <ErrorLine msg={err}/>
        </div>
      );
    }

    function App(){
      const [capital, setCapital] = useLocal('capital', 1000);
      const [profitPct, setProfitPct] = useLocal('profitPct', 7.5);
      const [holding, setHolding] = useLocal('holding', null);

      function handlePurchase(p){
        const bd = breakdown(p.capital, p.entry);
        const newHold = {
          symbol: p.symbol,
          entry: Number(p.entry),
          qty: bd.qty,
          capital: p.capital,
          buyFee: bd.buyFee,
          sellFee: bd.sellFee,
          breakeven: bd.breakeven,
          purchasedAt: new Date().toISOString()
        };
        setHolding(newHold);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      return (
        <div className="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
          <Header capital={capital} setCapital={setCapital} profitPct={profitPct} setProfitPct={setProfitPct} />
          <Top3 onPurchase={handlePurchase} capital={capital} profitPct={profitPct} />
          {holding ? <Holding holding={holding} profitPct={profitPct} onClear={()=>setHolding(null)} /> : <p className="muted text-sm">No active holding. Pick one above and “Mark as Purchased”.</p>}
          <footer className="py-8 text-center text-slate-500 text-xs">Built for educational purposes. Not financial advice.</footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
